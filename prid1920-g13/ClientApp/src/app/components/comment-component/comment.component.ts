import { Component, OnInit, Input, Output, EventEmitter } from "@angular/core";
import { AuthenticationService } from "src/app/services/authentication.service";
import { commentService } from "src/app/services/comment.service";
import { ReadQuestion } from "../readquestion/readquestion.component";
import {Comment} from "../../models/Comment";
import { EditCommentComponent } from "../edit-comment/edit-comment.component";
import * as _ from 'lodash';
import { MatSnackBar } from "@angular/material";


@Component({
    selector: 'app-comment',
    templateUrl: './comment.component.html',
    styleUrls: ['../readquestion/readquestion.component.css'],
})
export class CommentComponent implements OnInit {
    @Input() comments: Comment[];
    @Output() refreshAlert = new EventEmitter<any>();
    
    

    constructor(
        private readquestion: ReadQuestion,
        private authService: AuthenticationService,
        public comservice: commentService,
        public snackBar: MatSnackBar
        ) { }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    ngOnInit() {
      console.log(this.comments);
    }
    edit(comment: Comment) {
        const dlg = this.readquestion.dialog.open(EditCommentComponent, { data: { comment, isNew: false }, height: '800px', width: '600px', });
        dlg.beforeClose().subscribe(res => {
          if (res) {
            _.assign(comment, res);
            this.comservice.update(comment).subscribe(res => {
              if (!res) {
                this.readquestion.snackBar.open(`There was an error at the server. The update has not been done! Please try again.`, 'Dismiss', { duration: 10000 });
                this.refreshAlert.emit();
              }
              else {
                this.refreshAlert.emit();
              }
            });
          }
        });
      }
    
      delete(comment: Comment) {
        this.comments = _.filter(this.comments, c => c.id !== comment.id);
        this.readquestion.question.reponses.forEach(post => {
          post.comments = _.filter(post.comments, c => c.id !== comment.id);
        })
        const snackBarRef = this.snackBar.open(` Comment will be deleted`, 'Undo', { duration: 5000 });
        snackBarRef.afterDismissed().subscribe(res => {
          if (!res.dismissedByAction)
            this.comservice.delete(comment).subscribe();
          else
            this.refreshAlert.emit();
        });
      }
    
      addComment(postId: number) {
        const comment = new Comment({});
        const dlg = this.readquestion.dialog.open(EditCommentComponent, { data: { comment, isNew: true }, height: '600px', width: '600px', });
        dlg.beforeClose().subscribe(res => {
          if (res) {
            _.assign(comment, res);
            comment.author = this.readquestion.currentUser;
            comment.postId = postId;
            comment.timestamp = new Date(Date.now());
            this.comservice.addComment(comment).subscribe(res => {
              if (!res) {
                this.readquestion.snackBar.open(`There was an error at the server. The update has not been done! Please try again.`, 'Dismiss', { duration: 10000 });
                this.refreshAlert.emit();
              }
              else {
                this.refreshAlert.emit();
              }
            });
          }
        });
      }
    isComAuthor(com: Comment): boolean {
        return this.readquestion.currentUser && this.readquestion.currentUser === com.author;
      }
}